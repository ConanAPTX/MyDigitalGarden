---
{"number headings":"auto, first-level 4, max 6, contents
{ #toc}
, start-at 1, _.1.1","dg-publish":true,"permalink":"/15_OceanBase/01_部署 OceanBase 数据库/部署，管理 OceanBase 数据库/部署，管理 OBProxy/OBProxy 管理概述/","dgPassFrontmatter":true}
---


### OBProxy 管理概述
#### 1 OBProxy 概述

OceanBase 数据库是分布式数据库，每个表甚至每个表的不同分区都可能存放在不同的机器上。想要对表进行读写，必须先要定位到数据所属的表或是分区的主副本位置，然后才能执行相应的 SQL DML 语句，这在应用层面而言是几乎不可能做到的；

`OceanBase Database Proxy`，即 *OBProxy*，*ODP*；OBProxy 是 OceanBase 数据库专用的代理服务器；OceanBase 数据库的用户数据以多副本的形式存放在各个 OBServer 上，ODP 接收用户发出的 SQL 请求，并将 SQL 请求转发至最佳目标 OBServer，最后将执行结果返回给用户；

OBProxy 作为 OceanBase 数据库专用的反向代理软件，其核心功能就是路由以将客户端发起的数据访问请求转发到正确的 OBServer 上；

客户端通过 OBProxy 访问 OceanBase 数据库的数据链路如图所示，用户通过任意Client 驱动发出请求，请求通过负载均衡组件访问到任意一台无状态的 OBProxy 上，然后 OBProxy 再将用户请求转发到后端 OceanBase 集群中最佳的 OBServer 上去执行；

#### 2 OBProxy 核心功能:
OBProxy 核心功能：*路由*，*连接管理*，*监控&&运维*；

##### 2.1 路由:
OBProxy 作为 OceanBase 的高性能反向代理服务器，其核心功能就是*路由转发*； OBProxy 路由的目标是将具体 SQL 转发到最恰当的 Server 上执行，路由的核心过程包括：*简单的 SQL Parser*，*LDC 路由*，*读写分离*，*备优先读*，*黑名单机制*；

<svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="271px" width="491px" viewBox="-10 -10 511 291" content="&lt;mxGraphModel dx=&quot;968&quot; dy=&quot;371&quot; grid=&quot;1&quot; gridSize=&quot;10&quot; guides=&quot;1&quot; tooltips=&quot;1&quot; connect=&quot;1&quot; arrows=&quot;1&quot; fold=&quot;1&quot; page=&quot;0&quot; pageScale=&quot;1&quot; pageWidth=&quot;827&quot; pageHeight=&quot;1169&quot; math=&quot;0&quot; shadow=&quot;0&quot;&gt;&lt;root&gt;&lt;mxCell id=&quot;0&quot;/&gt;&lt;mxCell id=&quot;1&quot; parent=&quot;0&quot;/&gt;&lt;mxCell id=&quot;2&quot; value=&quot;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#f9f7ed;strokeColor=#36393d;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-110&quot; y=&quot;100&quot; width=&quot;490&quot; height=&quot;270&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;3&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size: 13px&amp;quot;&amp;gt;开始&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-60&quot; y=&quot;110&quot; width=&quot;40&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;4&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size: 13px&amp;quot;&amp;gt;解析 SQL&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-80&quot; y=&quot;150&quot; width=&quot;80&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;5&quot; value=&quot;&amp;lt;span style=&amp;quot;font-size: 13px&amp;quot;&amp;gt;确定路由规则&amp;lt;/span&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-80&quot; y=&quot;190&quot; width=&quot;80&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;6&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size: 13px&amp;quot;&amp;gt;获取路由表&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-80&quot; y=&quot;231&quot; width=&quot;80&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;7&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size: 13px&amp;quot;&amp;gt;选择目标Server&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-90&quot; y=&quot;280&quot; width=&quot;100&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;9&quot; value=&quot;&amp;lt;span style=&amp;quot;font-size: 13px&amp;quot;&amp;gt;黑名单检查&amp;lt;/span&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;-80&quot; y=&quot;323&quot; width=&quot;80&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;10&quot; value=&quot;是否通过&quot; style=&quot;rhombus;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;50&quot; y=&quot;303&quot; width=&quot;60&quot; height=&quot;60&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;11&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size: 13px&amp;quot;&amp;gt;转发 Request&amp;lt;/font&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;151&quot; y=&quot;323&quot; width=&quot;90&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;12&quot; value=&quot;&amp;lt;span style=&amp;quot;font-size: 13px&amp;quot;&amp;gt;结束&amp;lt;br&amp;gt;&amp;lt;/span&amp;gt;&quot; style=&quot;rounded=1;whiteSpace=wrap;html=1;fillColor=#1ba1e2;strokeColor=#006EAF;fontColor=#ffffff;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;281&quot; y=&quot;323&quot; width=&quot;80&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;13&quot; value=&quot;&amp;lt;font color=&amp;quot;#000000&amp;quot;&amp;gt;数据库名，表名，Hint...&amp;lt;/font&amp;gt;&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;40&quot; y=&quot;150&quot; width=&quot;140&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;15&quot; value=&quot;&amp;lt;font color=&amp;quot;#000000&amp;quot;&amp;gt;Leader 优先，LDC 优先，读写分离规则...&amp;lt;/font&amp;gt;&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;40&quot; y=&quot;190&quot; width=&quot;230&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;16&quot; value=&quot;&amp;lt;font color=&amp;quot;#000000&amp;quot;&amp;gt;非分区表路由表，分区表路由表&amp;lt;/font&amp;gt;&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;&quot; parent=&quot;1&quot; vertex=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;40&quot; y=&quot;230&quot; width=&quot;174&quot; height=&quot;20&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;18&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;&quot; parent=&quot;1&quot; source=&quot;4&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;200&quot; y=&quot;260&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;40&quot; y=&quot;160&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;19&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;&quot; parent=&quot;1&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint y=&quot;199&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;40&quot; y=&quot;199&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;20&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;exitX=1;exitY=0.5;exitDx=0;exitDy=0;dashed=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;&quot; parent=&quot;1&quot; source=&quot;6&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;10&quot; y=&quot;209&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;40&quot; y=&quot;240&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;22&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;&quot; parent=&quot;1&quot; source=&quot;3&quot; target=&quot;4&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;140&quot; y=&quot;320&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;190&quot; y=&quot;270&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;23&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;entryX=0.5;entryY=0;entryDx=0;entryDy=0;exitX=0.5;exitY=1;exitDx=0;exitDy=0;&quot; parent=&quot;1&quot; source=&quot;4&quot; target=&quot;5&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;140&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;160&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;24&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;exitX=0.5;exitY=1;exitDx=0;exitDy=0;&quot; parent=&quot;1&quot; source=&quot;5&quot; target=&quot;6&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;180&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;200&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;25&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;exitX=0.5;exitY=1;exitDx=0;exitDy=0;&quot; parent=&quot;1&quot; source=&quot;6&quot; target=&quot;7&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;220&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;241&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;26&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;exitX=0.5;exitY=1;exitDx=0;exitDy=0;entryX=0.5;entryY=0;entryDx=0;entryDy=0;&quot; parent=&quot;1&quot; source=&quot;7&quot; target=&quot;9&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;261&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;290&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;27&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;&quot; parent=&quot;1&quot; source=&quot;9&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;-30&quot; y=&quot;313&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;50&quot; y=&quot;333&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;28&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;exitX=1;exitY=0.5;exitDx=0;exitDy=0;entryX=0;entryY=0.5;entryDx=0;entryDy=0;&quot; parent=&quot;1&quot; source=&quot;10&quot; target=&quot;11&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;130&quot; y=&quot;333&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;60&quot; y=&quot;343&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;30&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;entryX=1;entryY=0.5;entryDx=0;entryDy=0;&quot; parent=&quot;1&quot; target=&quot;7&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;120&quot; y=&quot;333&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;95&quot; y=&quot;321&quot; as=&quot;targetPoint&quot;/&gt;&lt;Array as=&quot;points&quot;&gt;&lt;mxPoint x=&quot;120&quot; y=&quot;290&quot;/&gt;&lt;/Array&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;31&quot; value=&quot;&quot; style=&quot;endArrow=classic;html=1;strokeWidth=1;fillColor=#60a917;strokeColor=#2D7600;&quot; parent=&quot;1&quot; edge=&quot;1&quot;&gt;&lt;mxGeometry width=&quot;50&quot; height=&quot;50&quot; relative=&quot;1&quot; as=&quot;geometry&quot;&gt;&lt;mxPoint x=&quot;241&quot; y=&quot;333&quot; as=&quot;sourcePoint&quot;/&gt;&lt;mxPoint x=&quot;281&quot; y=&quot;333&quot; as=&quot;targetPoint&quot;/&gt;&lt;/mxGeometry&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;33&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size: 7px&amp;quot;&amp;gt;&amp;lt;font color=&amp;quot;#000000&amp;quot; style=&amp;quot;font-size: 7px&amp;quot;&amp;gt;输出&amp;lt;/font&amp;gt;xt&amp;lt;/font&amp;gt;&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;3&quot; y=&quot;149&quot; width=&quot;30&quot; height=&quot;10&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;35&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size: 7px&amp;quot;&amp;gt;&amp;lt;font color=&amp;quot;#000000&amp;quot; style=&amp;quot;font-size: 7px&amp;quot;&amp;gt;输出&amp;lt;/font&amp;gt;xt&amp;lt;/font&amp;gt;&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;3&quot; y=&quot;186&quot; width=&quot;30&quot; height=&quot;10&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;mxCell id=&quot;36&quot; value=&quot;&amp;lt;font style=&amp;quot;font-size: 7px&amp;quot;&amp;gt;&amp;lt;font color=&amp;quot;#000000&amp;quot; style=&amp;quot;font-size: 7px&amp;quot;&amp;gt;输出&amp;lt;/font&amp;gt;xt&amp;lt;/font&amp;gt;&quot; style=&quot;text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;whiteSpace=wrap;rounded=0;fontSize=9;&quot; vertex=&quot;1&quot; parent=&quot;1&quot;&gt;&lt;mxGeometry x=&quot;3&quot; y=&quot;230&quot; width=&quot;30&quot; height=&quot;10&quot; as=&quot;geometry&quot;/&gt;&lt;/mxCell&gt;&lt;/root&gt;&lt;/mxGraphModel&gt;"><style type="text/css"></style><rect x="0.5" y="0.5" width="490" height="270" rx="40.5" ry="40.5" fill="#f9f7ed" stroke="#36393d" pointer-events="none"/><rect x="50.5" y="10.5" width="40" height="20" rx="3" ry="3" fill="#1ba1e2" stroke="#006eaf" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 38px; height: 1px; padding-top: 21px; margin-left: 52px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font style="font-size: 13px">开始</font></div></div></div></foreignObject></g><rect x="30.5" y="50.5" width="80" height="20" rx="3" ry="3" fill="#1ba1e2" stroke="#006eaf" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 61px; margin-left: 32px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font style="font-size: 13px">解析 SQL</font></div></div></div></foreignObject></g><rect x="30.5" y="90.5" width="80" height="20" rx="3" ry="3" fill="#1ba1e2" stroke="#006eaf" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 101px; margin-left: 32px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><span style="font-size: 13px">确定路由规则</span></div></div></div></foreignObject></g><rect x="30.5" y="131.5" width="80" height="20" rx="3" ry="3" fill="#1ba1e2" stroke="#006eaf" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 142px; margin-left: 32px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font style="font-size: 13px">获取路由表</font></div></div></div></foreignObject></g><rect x="20.5" y="180.5" width="100" height="20" rx="3" ry="3" fill="#1ba1e2" stroke="#006eaf" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 98px; height: 1px; padding-top: 191px; margin-left: 22px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font style="font-size: 13px">选择目标Server</font></div></div></div></foreignObject></g><rect x="30.5" y="223.5" width="80" height="20" rx="3" ry="3" fill="#1ba1e2" stroke="#006eaf" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 234px; margin-left: 32px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><span style="font-size: 13px">黑名单检查</span></div></div></div></foreignObject></g><path d="M 190.5 203.5 L 220.5 233.5 L 190.5 263.5 L 160.5 233.5 Z" fill="#1ba1e2" stroke="#006eaf" stroke-miterlimit="10" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 58px; height: 1px; padding-top: 234px; margin-left: 162px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; ">是否通过</div></div></div></foreignObject></g><rect x="261.5" y="223.5" width="90" height="20" rx="3" ry="3" fill="#1ba1e2" stroke="#006eaf" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 88px; height: 1px; padding-top: 234px; margin-left: 263px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font style="font-size: 13px">转发 Request</font></div></div></div></foreignObject></g><rect x="391.5" y="223.5" width="80" height="20" rx="3" ry="3" fill="#1ba1e2" stroke="#006eaf" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 78px; height: 1px; padding-top: 234px; margin-left: 393px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #ffffff; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><span style="font-size: 13px">结束<br /></span></div></div></div></foreignObject></g><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 138px; height: 1px; padding-top: 61px; margin-left: 152px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #f0f0f0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font color="#000000">数据库名，表名，Hint...</font></div></div></div></foreignObject></g><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 228px; height: 1px; padding-top: 101px; margin-left: 152px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #f0f0f0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font color="#000000">Leader 优先，LDC 优先，读写分离规则...</font></div></div></div></foreignObject></g><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 172px; height: 1px; padding-top: 141px; margin-left: 152px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #f0f0f0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font color="#000000">非分区表路由表，分区表路由表</font></div></div></div></foreignObject></g><path d="M 110.5 60.5 L 144.13 60.5" fill="none" stroke="#2d7600" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 149.38 60.5 L 142.38 64 L 144.13 60.5 L 142.38 57 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 110.5 99.5 L 144.13 99.5" fill="none" stroke="#2d7600" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 149.38 99.5 L 142.38 103 L 144.13 99.5 L 142.38 96 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 110.5 141.5 L 144.13 140.66" fill="none" stroke="#2d7600" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><path d="M 149.38 140.53 L 142.47 144.2 L 144.13 140.66 L 142.3 137.2 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 30.5 L 70.5 44.13" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 49.38 L 67 42.38 L 70.5 44.13 L 74 42.38 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 70.5 L 70.5 84.13" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 89.38 L 67 82.38 L 70.5 84.13 L 74 82.38 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 110.5 L 70.5 125.13" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 130.38 L 67 123.38 L 70.5 125.13 L 74 123.38 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 151.5 L 70.5 174.13" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 179.38 L 67 172.38 L 70.5 174.13 L 74 172.38 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 200.5 L 70.5 217.13" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 70.5 222.38 L 67 215.38 L 70.5 217.13 L 74 215.38 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 110.5 233.5 L 154.13 233.5" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 159.38 233.5 L 152.38 237 L 154.13 233.5 L 152.38 230 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 220.5 233.5 L 255.13 233.5" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 260.38 233.5 L 253.38 237 L 255.13 233.5 L 253.38 230 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 230.5 233.5 L 230.5 200.5 Q 230.5 190.5 220.5 190.5 L 126.87 190.5" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 121.62 190.5 L 128.62 187 L 126.87 190.5 L 128.62 194 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 351.5 233.5 L 385.13 233.5" fill="none" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><path d="M 390.38 233.5 L 383.38 237 L 385.13 233.5 L 383.38 230 Z" fill="#2d7600" stroke="#2d7600" stroke-miterlimit="10" pointer-events="none"/><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 28px; height: 1px; padding-top: 55px; margin-left: 115px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 9px; font-family: Helvetica; color: #f0f0f0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font style="font-size: 7px"><font color="#000000" style="font-size: 7px">输出</font>xt</font></div></div></div></foreignObject></g><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 28px; height: 1px; padding-top: 92px; margin-left: 115px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 9px; font-family: Helvetica; color: #f0f0f0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font style="font-size: 7px"><font color="#000000" style="font-size: 7px">输出</font>xt</font></div></div></div></foreignObject></g><g><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 28px; height: 1px; padding-top: 136px; margin-left: 115px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 9px; font-family: Helvetica; color: #f0f0f0; line-height: 1.2; pointer-events: none; white-space: normal; word-wrap: normal; "><font style="font-size: 7px"><font color="#000000" style="font-size: 7px">输出</font>xt</font></div></div></div></foreignObject></g></svg>

##### 2.2 连接管理:
1. 在 observer 宕机/升级/重启时，客户端与 OBProxy 的连接不会断开，OBProxy 可以迅速切换到正常的 server上，对应用透明；
2. OBProxy 支持用户通过同一个 OBProxy 访问多个 OceanBase 集群；
3. Server session 对于每个 client session 独占；
4. 同一个 client session 对应 server session 状态保持相同(session变量同步)；


##### 2.3 监控&&运维



#### 3 OBProxy 执行流程 
>OBProxy 收到用户请求后，OBProxy 的执行流程：
>1. parse sql，通过简易parse，解析出sql涉及的table name、database name
>2. fetch route entry，根据用户的tenant name、database name、table name、partition id 向observer拉取该partition的路由表;
>3. sort route entry，根据各种相关属性对路由表中ip进行排序
>	1. read_consisitency：强一致性读or弱一致性读
>	2. 目标server状态：正在合并or常态
>	3. 路由精准度： PS or TS
>	4. LDC 匹配： 本地、同城、异地
>	5. Zone 类型
>	6. 读写分离的ob_route_policy取值
>4. filter by congestion，从路由表中依次尝试目标ip，通过黑名单进行过滤
>5. forward request，将用户请求转发给目标server
 
 

#### 4 OBProxy 主要路由策略
OBProxy 路由策略：*写请求*，写请求路由到 ReadWrite zone 的主副本；

*读请求*，读请求又分为`强一致性读`，`弱一致性读`；默认的路由策略为*强一致性读* 路由策略；

*强一致性读*：需要读取 partition 的 leader 副本的数据，即 SQL 必须转发到涉及 partition 的 leader server 上执行, 以此保证获取到实时最新的数据；强一致性读适用于对读写一致性要求高的场景；

*弱一致性读*：*主备均衡路由策略*（默认）；*备优先读策略*；*读写分离策略*；

##### 4.1 弱一致性读
###### 4.1.1 主备均衡路由策略
OBProxy 默认的路由方式为【`主备均衡路由`】；

该路由策略：`Region  > 合并状态 > IDC`；  
`首先`考虑 Region，相同 Region 的 OBServer 优先于不同 Region 的 OBServer；`其次`考虑合并状态，不处于合并状态的 OBServer 优先于处于合并状态的 OBServer；`最后`考虑 IDC 关系，相同 IDC 的 OBServer 优先于不同 IDC 的 OBServer；

> [!NOTE] 依据优先级从高到低，详细的路由顺序为：
> 1. 相同 Region，相同 IDC 并且不处于合并状态的 OBServer；
> 2. 相同 Region，不同 IDC 并且不处于合并状态的 OBServer；
> 3. 相同 Region，相同 IDC 并且处于合并状态的 OBServer；
> 4. 相同 Region，不同 IDC 并且处于合并状态的 OBServer；
> 5. 不同 Region 并且不处于合并状态的 OBServer；
> 6. 不同 Region 并且处于合并状态的 OBServer；

###### 4.1.2 备优先读策略
当 *proxy_route_policy* 的值为不同时，使用不同的路由策略：`备优先读策略`，`不合并备优先读策略`；

在常规模式部署 + 弱一致性读时：OBProxy 支持备优先读路由策略，通过用户级别系统变量 `proxy_route_policy` 控制备优先读路由。【*备优先读*】仅在弱一致性读时生效，且优先读 follower 而非主备均衡选择；



```sql
-- 使用 root 用户登录集群的 sys 租户

-- 设置用户系统变量 proxy_route_policy 
SET @proxy_route_policy = 'follower_first';            -- 取值为 follower_first 时，路由逻辑是优先发备（即使集群在合并状态）；
SET @proxy_route_policy = 'unmerge_follower_first';    -- 取值为 unmerge_follower_first 时，路由逻辑是优先发不在集群合并状态的备机（Follower 节点）；
	-- 注意：当取其他值时，退化至普通弱一致性读主备均衡的路由逻辑；

-- 验证命令 
select @proxy_route_policy;
show proxysession variables;
```

*系统变量 proxy_route_policy 值为 follower_first*：【备优先读策略】：`Region > 主备角色 > 合并状态 > IDC`； 

`依据优先级从高到低，详细的路由顺序为`：
同机房不合并的备 --> 同城不同机房不合并的备 --> 同机房在合并的备 --> 同城不同机房合并的备 --> 同机房不合并的主 --> 同城不同机房不合并的主 --> 不同城不合并的备 --> 不同城合并的备 --> 不同城不合并的主 --> 不同城合并的主；
注意：*同机房*：相同 Region，相同 IDC；*同城不同机房*：相同 Region，不同 IDC；*不同城*：不同 Region；


*系统变量 proxy_route_policy 值为 unmerge_follower_first*：【不合并备优先读策略】：`Region > 合并状态 > 主备角色 > IDC`；  

`依据优先级从高到低，详细的路由顺序为`：
同机房不合并的备 --> 同城不同机房不合并的备 --> 同机房不合并的主 --> 同城不同机房不合并的主 --> 同机房在合并的备 --> 同城不同机房合并的备 --> 不同城不合并的备 --> 不同城不合并的主 --> 不同城合并的备 --> 不同城合并的主；
注意：*同机房*：相同 Region，相同 IDC；*同城不同机房*：相同 Region，不同 IDC；*不同城*：不同 Region；


###### 4.1.3 读写分离策略
读写分离部署，要求客户端将写请求路由到 ReadWrite Zone 主副本，将弱一致性读请求路由到 ReadOnly Zone；


```sql
-- 使用 root 用户登录到集群的业务租户

-- 设置 Global 级别系统变量 ob_route_policy
set @@global.ob_route_policy = readonly_zone_first;
```

1. `ob_route_policy`：用于设置 obproxy 或 Java 客户端与 OBServer 节点内部重试的路由策略；

<div class="transclusion internal-embed is-loaded"><a class="markdown-embed-link" href="/15-ocean-base/02-ocean-base/02/ob/ocean-base/#bd3f74" aria-label="Open link"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></a><div class="markdown-embed">



6. `ob_route_policy`：用于设置 OBProxy 或 Java 客户端与 OBServer 内部重试的路由策略； 

</div></div>










[[15_OceanBase/03_OceanBase 高阶进阶/事务管理/OceanBase 一致性级别的指定方式\|OceanBase 一致性级别的指定方式]]，；


### 参考文档：





